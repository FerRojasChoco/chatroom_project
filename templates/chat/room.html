{% extends 'base.html' %}
{% block content %}

<div class="message-box">
    <h2>Chat Room: {{code}} <span id="member-count">(1 user)</span></h2>
    
    <div id="ready-section">
        <button id="ready-btn" onclick="toggleReady()">I'm Ready</button>
        <div id="ready-status">0/1 players ready</div>
    </div>
    
    <pre id="code-snippet" style="display: none;"></pre>
    <div id="game-progress" style="display: none;"></div>
    <div class="messages" id="messages-container"></div>
    
    <div class="inputs" id="chat-inputs" style="display: none;">
        <input 
            type="text" 
            rows="3" 
            placeholder="..." 
            name="message" 
            id="message-input"
            aria-label="Message input"/>
        <button type="button" name="send" id="send-button" onclick="sendMessage()">
            Send
        </button>
    </div>
</div>

<script type="text/javascript">
    const socketio = io();
    const messagesContainer = document.getElementById("messages-container");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    let isReady = false;

    //~~~ Create message element ~~~//
    const createMessageElement = (name, msgText) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-text');

        const nameStrong = document.createElement('strong');
        nameStrong.textContent = name;

        const msgSpan = document.createElement('span');
        msgSpan.textContent = (name === "System" ? "" : ": ") + msgText;

        const timeSpan = document.createElement('span');
        timeSpan.classList.add('muted-timestamp');
        timeSpan.textContent = new Date().toLocaleTimeString();

        messageDiv.appendChild(nameStrong);
        messageDiv.appendChild(msgSpan);
        const br = document.createElement('br');
        messageDiv.appendChild(br);
        messageDiv.appendChild(timeSpan);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    //~~~ Ready system ~~~//
    function toggleReady() {
        isReady = !isReady;
        const readyBtn = document.getElementById("ready-btn");
        if (isReady) {
            readyBtn.textContent = "Cancel Ready";
            readyBtn.classList.add("ready-active");
            socketio.emit("ready");
        } else {
            readyBtn.textContent = "I'm Ready";
            readyBtn.classList.remove("ready-active");
        }
    }

    //~~~ Socket handlers ~~~//
    socketio.on("user_ready", (data) => {
        document.getElementById("ready-status").textContent = 
            `${data.ready_count}/${data.total_users} players ready`;
        
        if (data.name) {
            createMessageElement("System", `${data.name} is ready`);
        }
    });

    socketio.on("game_started", (data) => {
        document.getElementById("ready-section").style.display = "none";
        document.getElementById("code-snippet").style.display = "block";
        document.getElementById("game-progress").style.display = "block";
        document.getElementById("game-progress").textContent = 
            `Game started! ${data.snippets_remaining} snippets remaining`;
        document.getElementById("chat-inputs").style.display = "flex";
        createMessageElement("System", data.message);
    });

    socketio.on("new_snippet", (data) => {
        document.getElementById("code-snippet").textContent = data.snippet;
        document.getElementById("game-progress").textContent = data.message;
        createMessageElement("System", `New code snippet: ${data.message}`);
    });

    socketio.on("game_ended", (data) => {
        document.getElementById("code-snippet").style.display = "none";
        document.getElementById("game-progress").style.display = "none";
        document.getElementById("chat-inputs").style.display = "none";
        
        if (data.show_ready) {
            document.getElementById("ready-section").style.display = "block";
            document.getElementById("ready-btn").textContent = "I'm Ready";
            document.getElementById("ready-btn").classList.remove("ready-active");
            isReady = false;
        }
        
        createMessageElement("System", data.message);
    });

    socketio.on("member_count_update", (data) => {
        const count = data.count;
        const readyCount = data.ready_count || 0;
        document.getElementById("member-count").textContent = 
            count === 1 ? "(1 user)" : `(${count} users)`;
        document.getElementById("ready-status").textContent = 
            `${readyCount}/${count} players ready`;
    });

    socketio.on("message", (data) => {
        createMessageElement(data.name, data.message);
    });

    //~~~ Message sending ~~~//
    function sendMessage() {
        const messageText = messageInput.value.trim();
        if (messageText === "") return;
        
        socketio.emit("message", { data: messageText });
        messageInput.value = "";
        messageInput.focus();
    }

    //~~~ Event listeners ~~~//
    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    //~~~ Load initial messages ~~~//
    try {
        const initialMessages = JSON.parse('{{ messages | tojson | safe }}');
        if (Array.isArray(initialMessages)) {
            initialMessages.forEach(msg => {
                if (msg && typeof msg.name !== 'undefined' && typeof msg.message !== 'undefined') {
                    createMessageElement(msg.name, msg.message);
                }
            });
        }
    } catch (e) {
        console.error("Error parsing initial messages:", e);
    }
</script>

{% endblock %}